pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          containers:
          - name: general
            image: busybox:stable
            command:
            - cat
            tty: true
          - name: docker
           image: docker:latest
           command:
           - cat
           tty: true
           volumeMounts:
            - mountPath: /var/run/docker.sock
              name: docker-sock
          volumes:
          - name: docker-sock
            hostPath:
              path: /var/run/docker.sock
        '''
    }
  }
  stages {
    stage('Build Database') {
      steps {
        container('docker')
        dir('CDDBAPI/Database') {
            sh 'docker build -t '
        }
      }
    }
    stage('Test') {
      steps {
        sh '''
          if curl http://localhost:8181/api/compactdiscs | grep -i coldplay
          then
            success=0
          else
            success=1
          fi
          exit $success
        '''
      }
    }
    stage('Publish') {
      steps {
        sh '''
          echo 'Publish to our containers repository'
          docker compose images
          echo "docker compose push"
        '''
      }
    }
    stage('Clean Up') {
      steps {
        sh '''
          docker compose down --rmi all -v
        '''
      }
    }
  }
}
